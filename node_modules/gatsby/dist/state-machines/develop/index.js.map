{"version":3,"sources":["../../../src/state-machines/develop/index.ts"],"names":["developConfig","id","initial","on","ADD_NODE_MUTATION","actions","QUERY_FILE_CHANGED","WEBHOOK_RECEIVED","target","states","initializing","undefined","invoke","src","onDone","initializingData","data","parentSpan","store","webhookBody","deferNodeMutation","runningQueries","program","gatsbyNodeGraphQLFunction","graphqlRunner","websocketManager","cond","compiler","startingDevServers","waiting","entry","EXTRACT_QUERIES_NOW","nodeMutationBatch","runningBatch","reloadingData","recreatingPages","developMachine","services","developServices","buildActions"],"mappings":"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","sourcesContent":["import { MachineConfig, AnyEventObject, forwardTo, Machine } from \"xstate\"\nimport { IDataLayerContext } from \"../data-layer/types\"\nimport { IQueryRunningContext } from \"../query-running/types\"\nimport { IWaitingContext } from \"../waiting/types\"\nimport { buildActions } from \"./actions\"\nimport { developServices } from \"./services\"\nimport { IBuildContext } from \"../../services\"\n\n/**\n * This is the top-level state machine for the `gatsby develop` command\n */\nconst developConfig: MachineConfig<IBuildContext, any, AnyEventObject> = {\n  id: `build`,\n  initial: `initializing`,\n  // These are mutation events, sent to this machine by the mutation listener\n  // in `services/listen-for-mutations.ts`\n  on: {\n    // These are deferred node mutations, mainly `createNode`\n    ADD_NODE_MUTATION: {\n      actions: `addNodeMutation`,\n    },\n    // Sent by query watcher, these are chokidar file events. They mean we\n    // need to extract queries\n    QUERY_FILE_CHANGED: {\n      actions: `markQueryFilesDirty`,\n    },\n    // These are calls to the refresh endpoint. Also used by Gatsby Preview.\n    // Saves the webhook body from the event into context, then reloads data\n    WEBHOOK_RECEIVED: {\n      target: `reloadingData`,\n      actions: `assignWebhookBody`,\n    },\n  },\n  states: {\n    // Here we handle the initial bootstrap\n    initializing: {\n      on: {\n        // Ignore mutation events because we'll be running everything anyway\n        ADD_NODE_MUTATION: undefined,\n        QUERY_FILE_CHANGED: undefined,\n        WEBHOOK_RECEIVED: undefined,\n      },\n      invoke: {\n        src: `initialize`,\n        onDone: {\n          target: `initializingData`,\n          actions: [`assignStoreAndWorkerPool`, `spawnMutationListener`],\n        },\n      },\n    },\n    // Sourcing nodes, customising and inferring schema, then running createPages\n    initializingData: {\n      on: {\n        // We need to run mutations immediately when in this state\n        ADD_NODE_MUTATION: {\n          actions: [`markNodesDirty`, `callApi`],\n        },\n        // Ignore, because we're about to extract them anyway\n        QUERY_FILE_CHANGED: undefined,\n      },\n      invoke: {\n        src: `initializeData`,\n        data: ({\n          parentSpan,\n          store,\n          webhookBody,\n        }: IBuildContext): IDataLayerContext => {\n          return {\n            parentSpan,\n            store,\n            webhookBody,\n            deferNodeMutation: true,\n          }\n        },\n        onDone: {\n          actions: [\n            `assignServiceResult`,\n            `clearWebhookBody`,\n            `finishParentSpan`,\n          ],\n          target: `runningQueries`,\n        },\n      },\n    },\n    // Running page and static queries and generating the SSRed HTML and page data\n    runningQueries: {\n      on: {\n        QUERY_FILE_CHANGED: {\n          actions: forwardTo(`run-queries`),\n        },\n      },\n      invoke: {\n        id: `run-queries`,\n        src: `runQueries`,\n        // This is all the data that we're sending to the child machine\n        data: ({\n          program,\n          store,\n          parentSpan,\n          gatsbyNodeGraphQLFunction,\n          graphqlRunner,\n          websocketManager,\n        }: IBuildContext): IQueryRunningContext => {\n          return {\n            program,\n            store,\n            parentSpan,\n            gatsbyNodeGraphQLFunction,\n            graphqlRunner,\n            websocketManager,\n          }\n        },\n        onDone: [\n          {\n            // If we have no compiler (i.e. it's first run), then spin up the\n            // webpack and socket.io servers\n            target: `startingDevServers`,\n            actions: `setQueryRunningFinished`,\n            cond: ({ compiler }: IBuildContext): boolean => !compiler,\n          },\n          {\n            // ...otherwise just wait.\n            target: `waiting`,\n          },\n        ],\n      },\n    },\n    // Spin up webpack and socket.io\n    startingDevServers: {\n      invoke: {\n        src: `startWebpackServer`,\n        onDone: {\n          target: `waiting`,\n          actions: `assignServers`,\n        },\n      },\n    },\n    // Idle, waiting for events that make us rebuild\n    waiting: {\n      // We may want to save this is more places, but this should do for now\n      entry: `saveDbState`,\n      on: {\n        // Forward these events to the child machine, so it can handle batching\n        ADD_NODE_MUTATION: {\n          actions: forwardTo(`waiting`),\n        },\n        QUERY_FILE_CHANGED: {\n          actions: forwardTo(`waiting`),\n        },\n        // This event is sent from the child\n        EXTRACT_QUERIES_NOW: {\n          target: `runningQueries`,\n        },\n      },\n      invoke: {\n        id: `waiting`,\n        src: `waitForMutations`,\n        // Send existing queued mutations to the child machine, which will execute them\n        data: ({\n          store,\n          nodeMutationBatch = [],\n        }: IBuildContext): IWaitingContext => {\n          return { store, nodeMutationBatch, runningBatch: [] }\n        },\n        // \"done\" means we need to rebuild\n        onDone: {\n          actions: `assignServiceResult`,\n          target: `recreatingPages`,\n        },\n      },\n    },\n    // Almost the same as initializing data, but skips various first-run stuff\n    reloadingData: {\n      on: {\n        // We need to run mutations immediately when in this state\n        ADD_NODE_MUTATION: {\n          actions: [`markNodesDirty`, `callApi`],\n        },\n        // Ignore, because we're about to extract them anyway\n        QUERY_FILE_CHANGED: undefined,\n      },\n      invoke: {\n        src: `reloadData`,\n        data: ({\n          parentSpan,\n          store,\n          webhookBody,\n        }: IBuildContext): IDataLayerContext => {\n          return {\n            parentSpan,\n            store,\n            webhookBody,\n            deferNodeMutation: true,\n          }\n        },\n        onDone: {\n          actions: [\n            `assignServiceResult`,\n            `clearWebhookBody`,\n            `finishParentSpan`,\n          ],\n          target: `runningQueries`,\n        },\n      },\n    },\n    // Rebuild pages if a node has been mutated outside of sourceNodes\n    recreatingPages: {\n      invoke: {\n        src: `recreatePages`,\n        data: ({ parentSpan, store }: IBuildContext): IDataLayerContext => {\n          return { parentSpan, store, deferNodeMutation: true }\n        },\n        onDone: {\n          actions: `assignServiceResult`,\n          target: `runningQueries`,\n        },\n      },\n    },\n  },\n}\n\nexport const developMachine = Machine(developConfig, {\n  services: developServices,\n  actions: buildActions,\n})\n"],"file":"index.js"}